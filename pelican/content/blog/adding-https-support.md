---
Title: Adding HTTPS support to this site
Date: 2016-01-23 10:00
Author: Carey Metcalfe
Tags:
  - website
  - security
---

Yesterday I finally ticked something off my TODO list that'd been on there for a while - I added
HTTPS support to this site.

The Qualys SSL Labs [SSL Server Test][] now gives this site [an A rating][]. An A+ rating is
achievable simply by enabling [HSTS][] but at the moment some issues prevent me from doing so.
Expect that to change at some point though.

You can see all the certs (past and present) for this site on [crt.sh][], an online certificate
search tool.

### For those interested in how things work:

[Let's Encrypt][] is a "free, automated, and open" certificate authority. They provide certificates
via an [automatable process][] that are valid for [90 days][]. Since I wanted to support HTTPS on
the site, I like free things, and the deployment of this site is almost completely automated anyway,
it seemed like a good fit.

Because of my largely custom deployment setup, it took a bit of doing to get it all working
together. Exactly how it works can be seen in my [website repo][] where this entire site and it's
deployment scripts are kept, but here's the gist of it:

I decided to use [letsencrypt.sh][] instead of the [official Let's Encrypt client][] to generate
certs from Let's Encrypt. The official client just seems too big (~26,000 LOC!) and more "magic"
than it needs to be - it tries to do everything. It pulls in half of [PyPI][] as dependencies,
automatically modifies web server configurations, asks questions interactively, etc.

[letsencrypt.sh][] on the other hand is ~700 lines of bash and only requires things like `openssl`,
`curl`, and other programs that any UNIX system should already have. It takes a config file, a list
of domains, and a private key. Once those are in place running it from [cron][] is easy.

The [ACME protocol][] that Let's Encrypt uses to verify domain ownership requires the web server to
respond to certain requests. This check makes sure that only someone with control over the domain
can generated a cert for it. To allow those requests to return the files generated by letsencrypt.sh
I had to open up a [hole in the Nginx config][].

Initially there were problems with the first time generating certs. Since the certs didn't exist
yet, Nginx was failing to start (and therefore causing the domain validation to fail). The solution
was to put all HTTPS-related options in a separate config file and include it from the main one.
Then if the files didn't exist, the HTTPS file would be replaced with a blank one, allowing Nginx to
start without issue. After the certs were generated the file would simply be moved back, re-enabling
HTTPS.

This is maybe not the cleanest way of doing things, but it's working for now. Unfortunately this
means that automatic HTTP -> HTTPS rewriting and [HSTS][] can't be enabled. Doing so would cause the
Let's Encrypt client to try to hit the HTTPS URLs during renewal which, during the initial
deployment, may not exist.

Minor issues aside, both generating a cert for the first time and renewing a cert is as easy as
deploying the site. For continual, automated renewals, I also added a cron job to run the renewal
script once a month. With the expiry of certs being 90 days, this should be frequent enough that the
certs should never expire.

 [SSL Server Test]: https://www.ssllabs.com/ssltest/index.html
 [an A rating]: https://www.ssllabs.com/ssltest/analyze.html?d=cmetcalfe.ca
 [HSTS]: https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security
 [crt.sh]: https://crt.sh/?q=cmetcalfe.ca&iCAID=7395
 [Let's Encrypt]: https://letsencrypt.org/
 [automatable process]: https://letsencrypt.org/howitworks/technology/
 [90 days]: https://letsencrypt.org/2015/11/09/why-90-days.html
 [website repo]: https://github.com/pR0Ps/website
 [letsencrypt.sh]: https://github.com/lukas2511/letsencrypt.sh
 [official Let's Encrypt client]: https://github.com/letsencrypt/letsencrypt
 [PyPI]: https://pypi.python.org/pypi
 [cron]: https://en.wikipedia.org/wiki/Cron
 [ACME protocol]: https://github.com/letsencrypt/acme-spec
 [hole in the Nginx config]: https://github.com/pR0Ps/website/blob/f9d7583365bc0279ffe8d1fe2402494f00673da5/web_config/nginx/www.conf#L60-L63
